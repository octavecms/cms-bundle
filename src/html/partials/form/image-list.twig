{% from 'macros/icon.twig' import icon %}

{% set id = id|default('input-' ~ random()) %}
{% set imageListId = id %}
{% set name = name|default('') %}
{% set value = value|default([]) %}
{% set disabled = disabled|default(false) %}
{% set readonly = readonly|default(false) %}
{% set editable = editable|default(false) %}
{% set hasEditable = editable|length|default(0) %}

<div class="image-list {% if readonly or disabled %}image-list--disabled{% endif %}"
    {% if not readonly and not disabled %}
        data-plugin="sortableList"
        data-sortable-list-handle-selector=""
        data-sortable-list-list-selector=".js-image-list-list"
        data-sortable-list-force-start-selector=".js-image-list-force-start"
        data-sortable-list-force-end-selector=".js-image-list-force-end"
        data-sortable-list-filter-selector=".js-image-list-not-draggable"
        data-sortable-list-cancel-selector=".js-image-list-not-draggable"
        data-sortable-list-draggable-selector=".js-image-list-item"
    {% endif %}
>
    <ol class="image-list__list js-image-list-list">
        {% for item in value %}
            {% set index = loop.index0 %}
            {% set id = item.id|default('') %}
            {% set fileName = item.fileName|default('') %}
            {% set thumbnail = item.thumbnail|default('') %}
            {% set url = item.url|default('') %}
            {% set meta = item.meta|default('') %}
            {% set hasEditableValues = false %}

            {% for key, value in meta %}
                {% if value %}
                    {% set hasEditableValues = true %}
                {% endif %}
            {% endfor %}

            <li class="image-list__list__item image-item js-image-list-item" aria-label="Image {{ fileName }}">
                <input type="hidden" name="{{ name }}[{{ index }}][id]" value="{{ id }}" {% if disabled %}disabled{% endif %} />
                <input type="hidden" name="{{ name }}[{{ index }}][order]" value="{{ index }}" {% if disabled %}disabled{% endif %} />

                <div class="image-item__sizer"></div>
                <div class="image-item__image">
                    {% if thumbnail %}
                        {# Thumbnail image #}
                        <img src="{{ thumbnail }}" alt="{{ fileName }}" draggable="false" {% if url %}data-full-image-url="{{ url }}"{% endif %} />
                    {% elseif url %}
                        {# Full image, this is not optimal due to possibly large image sizes #}
                        <img src="{{ url }}" alt="{{ fileName }}" draggable="false" />
                    {% endif %}
                </div>
                <div class="image-item__controls ui-gray">
                    <div class="group group--2">
                        {# Meta button shown on readonly #}
                        {% if hasEditable and not disabled and (not readonly or hasEditableValues) %}
                            <a
                                role="button"
                                tabindex="0"
                                class="btn btn--tetriary btn--shadow btn--square btn--pill js-image-list-not-draggable {% if hasEditableValues %}is-highlighted{% endif %}"
                                aria-label="Change image information"

                                data-plugin="editable"
                                href="#{{ imageListId }}-editable"
                            ><span class="btn__content">
                                {{ icon('note', {width: 32, height: 32}) }}
                            </span></a>

                            {# Editable hidden inputs which hold values #}
                            {% for editableItem in editable %}
                                {% set value = meta[editableItem.name]|default('') %}
                                <input type="hidden" name="{{ name }}[<%- index %>][{{ editableItem.name }}]" value="{{ value }}" />
                            {% endfor %}
                        {% endif %}

                        {% if not readonly and not disabled %}
                            <a role="button" tabindex="0" class="btn btn--tetriary btn--shadow btn--square btn--pill js-image-list-not-draggable group__right" aria-label="Change image"><span class="btn__content">
                                {{ icon('edit', {width: 32, height: 32}) }}
                            </span></a>
                            <a role="button" tabindex="0" class="btn btn--tetriary btn--shadow btn--square btn--pill js-image-list-not-draggable" aria-label="Remove image"><span class="btn__content">
                                {{ icon('delete', {width: 32, height: 32}) }}
                            </span></a>
                        {% endif %}
                    <div>
                </div>
            </li>
        {% endfor %}

        {# Client-side template #}
        {% if not readonly and not disabled %}
            <script type="text/template">
                <li class="image-list__list__item image-item js-image-list-item" aria-label="Image <%- fileName %>">
                    <input type="hidden" name="{{ name }}[<%- index %>][id]" value="<%- id %>" />
                    <input type="hidden" name="{{ name }}[<%- index %>][order]" value="<%- index %>" />

                    <div class="image-item__sizer"></div>
                    <div class="image-item__image">
                        <% if (thumbnail) { %>
                            {# Thumbnail image #}
                            <img src="<%- thumbnail %>" alt="<%- fileName %>" draggable="false" <% if (url) { %>data-full-image-url="<%- url %>"<% } %> onerror="this.src='/assets/images/file-icons/unknown.png'" />
                        <% } else if (url) { %>
                            {# Full image, this is not optimal due to possibly large image sizes #}
                            <img src="<%- url %>" alt="<%- fileName %>" draggable="false" onerror="this.src='/assets/images/file-icons/unknown.png'" />
                        <% } %>
                    </div>
                    <div class="image-item__controls ui-gray">
                        <div class="group group--2">
                            {% if hasEditable %}
                                <a
                                    role="button"
                                    tabindex="0"
                                    class="btn btn--tetriary btn--shadow btn--square btn--pill js-image-list-not-draggable"
                                    aria-label="Change image information"

                                    data-plugin="editable"
                                    href="#{{ imageListId }}-editable"
                                ><span class="btn__content">
                                    {{ icon('note', {width: 32, height: 32}) }}
                                </span></a>

                                {# Editable hidden inputs which hold values #}
                                {% for editableItem in editable %}
                                    <input type="hidden" name="{{ name }}[<%- index %>][{{ editableItem.name }}]" value="" />
                                {% endfor %}
                            {% endif %}

                            <a role="button" tabindex="0" class="btn btn--tetriary btn--shadow btn--square btn--pill js-image-list-not-draggable group__right" aria-label="Change image"><span class="btn__content">
                                {{ icon('edit', {width: 32, height: 32}) }}
                            </span></a>
                            <a role="button" tabindex="0" class="btn btn--tetriary btn--shadow btn--square btn--pill js-image-list-not-draggable" aria-label="Remove image"><span class="btn__content">
                                {{ icon('delete', {width: 32, height: 32}) }}
                            </span></a>
                        <div>
                    </div>
                </li>
            </script>
        {% endif %}


        {% if not readonly and not disabled %}
            <li class="image-list-control-item js-image-list-force-end">
                <div class="image-list-control-item__sizer"></div>
                <a role="button" tabindex="0" class="image-list-control-item__content btn-container">
                    <span class="btn btn--tetriary btn--square btn--pill"><span class="btn__content">
                        {{ icon('add', {width: 32, height: 32}) }}
                    </span></span>
                    <span class="image-list-control-item__content__text">Add Images</span>
                </a>
            </li>
        {% endif %}
    </ol>
</div>

{# Editable popup (dropdown) form content #}
{% if editable %}
    {% include 'partials/editable.twig' with {
        id: imageListId ~ '-editable',
        form: editable
    } %}
{% endif %}